# Импорт фильмов из Radarr

## Назначение

Модуль импорта фильмов отвечает за синхронизацию данных о фильмах
между Radarr и внутренней базой данных сервиса.
Он обеспечивает:

- регулярное обновление метаданных фильмов (название, дата релиза, статус и др.);
- создание новых записей, если фильма нет в системе;
- обновление существующих записей при изменении статуса или идентификаторов.

Импорт может быть инициирован вручную через HTTP API
или выполняться по расписанию (cron, раз в сутки).

## Архитектура и поток данных

- Источник данных — Radarr API, эндпоинт /api/v3/movie.
- Метод получения — HTTP GET с API ключом Radarr.
- Полученные данные — JSON-массив фильмов.
- Сервис-обработчик анализирует каждый фильм:
  - ищет по radarr_id, затем по tmdbId, затем по imdbId
  - если не найден — создаёт новую запись
  - если найден — обновляет при необходимости (status, releaseDate, идентификаторы).
- Результат — обновлённая таблица фильмов (media, movies) в базе данных.
- Обратная связь — JSON-ответ с количеством импортированных и обновлённых фильмов, либо с ошибкой.

```mermaid
flowchart TD
    A[Старт импорта / cron-задача / ручной вызов API] --> B[Запрос списка фильмов из Radarr API]
    B -->|Успешно| C[Для каждого фильма из ответа]
    B -->|Ошибка| E1[Ошибка подключения / RADARR_FETCH_FAILED] --> Z[Завершение с ошибкой]

    C --> D[Проверить наличие фильма в БД по radarr_id]
    D -->|Есть| E[Обновить существующую запись<br/>(tmdb_id, imdb_id, title, path, rating, и т.д.)]
    D -->|Нет| F[Создать новую запись в таблице<br/>media и movies]

    E --> G[Обновить дату обновления / watched / poster]
    F --> G
    G --> H[Следующий фильм]
    H -->|Все обработаны| I[Сформировать отчёт об импорте]
    I --> J[Вернуть ответ API<br/>успешные / обновлённые / ошибки]
    J --> Z[Завершение процесса]

```

Краткое описание шагов

| **Шаг** | **Описание**                                                                                         |
| ------- | ---------------------------------------------------------------------------------------------------- |
| **A**   | Инициатором может быть cron-задача, ручной запрос `/api/v1/radarr/import/` или системное событие.    |
| **B**   | Выполняется GET-запрос к Radarr API `/api/v3/movie/`.                                                |
| **C–D** | Перебор фильмов. Проверка по `radarr_id` → если найден — обновляем, если нет — создаём новую запись. |
| **E–F** | Обновление/создание записей в таблицах `media` и `movies`.                                           |
| **G**   | Обновление метаданных (дата, просмотр, обложка).                                                     |
| **I–J** | Формируется и возвращается отчёт (кол-во новых, обновлённых, пропущенных).                           |
| **Z**   | Завершение процесса с логированием.                                                                  |

```pgsql
+-----------------------------------------------------------+
|                        Radarr API                         |
|-----------------------------------------------------------|
|  • /api/v3/movie                                           |
|  • Требуется X-Api-Key                                     |
|  • Возвращает JSON со списком фильмов                      |
+-----------------------------------------------------------+
                            |
                            |  (HTTP GET, каждые 24ч или вручную)
                            v
+-----------------------------------------------------------+
|                  Radarr Import Service                     |
|-----------------------------------------------------------|
|  • Эндпоинт: /api/v1/radarr/import                        |
|  • Получает список фильмов из Radarr                       |
|  • Проверяет наличие по radarr_id / tmdb_id / imdb_id      |
|  • Сохраняет новые фильмы                                 |
|  • Обновляет существующие записи                           |
|  • Формирует ответ RadarrImportResponse                    |
+-----------------------------------------------------------+
                            |
                            |  (ORM — SQLAlchemy)
                            v
+-----------------------------------------------------------+
|                        Database                            |
|-----------------------------------------------------------|
|  media                                                     |
|   ├── id (PK)                                              |
|   ├── media_type ("movie"|"series")                        |
|   ├── title                                                |
|   ├── release_date                                         |
|   ├── created_at                                           |
|                                                             |
|  movies                                                    |
|   ├── id (FK → media.id)                                   |
|   ├── radarr_id (unique)                                   |
|   ├── tmdb_id (unique)                                     |
|   ├── imdb_id (unique)                                     |
|   ├── jellyfin_id (unique)                                 |
+-----------------------------------------------------------+
                            |
                            |  (доступ через ORM / API)
                            v
+-----------------------------------------------------------+
|                    Application Core                        |
|-----------------------------------------------------------|
|  • REST API (FastAPI)                                     |
|  • Метрики и логи                                           |
|  • Обработка ошибок (ErrorCode, RadarrErrorCode и др.)     |
|  • Возможность ручного триггера импорта                    |
+-----------------------------------------------------------+
                            |
                            |  (взаимодействие через HTTP)
                            v
+-----------------------------------------------------------+
|                     UI / Dashboard / API Client            |
|-----------------------------------------------------------|
|  • Просмотр фильмов                                        |
|  • Отображение статистики импорта                          |
|  • Управление запуском импорта                             |
+-----------------------------------------------------------+

```
## Конфигурация доступа

Для получения списка фильмов требуется API-ключ Radarr.
Его можно получить в интерфейсе Radarr:
Settings → General → Security → API Key

Пример запроса
```shell
curl --location 'http://192.168.1.11:7878/api/v3/movie' \
--header 'X-Api-Key: apiKeyRadarr'
```
## Формат ответа Radarr API

Radarr возвращает массив фильмов в формате JSON.
Каждый объект содержит метаданные фильма. Ниже приведён пример
и описание структуры.

Пример ответа
```json
[
  {
    "title": "Курт Кобейн: Чёртов Монтаж",
    "originalTitle": "Cobain: Montage of Heck",
    "originalLanguage": {"id": 1, "name": "English"},
    "status": "released",
    "overview": "Взгляд на жизнь, творчество и мысли Курта Кобейна...",
    "inCinemas": "2015-03-23T00:00:00Z",
    "releaseDate": "2015-03-21T00:00:00Z",
    "images": [
      {"coverType": "poster", "remoteUrl": "https://image.tmdb.org/t/p/original/d0DgEvMNrGGlUXqyQ7HJbgnIxO7.jpg"}
    ],
    "tmdbId": 319075,
    "imdbId": "tt4229236",
    "path": "/data/media/movies/Cobain Montage of Heck (2015)",
    "year": 2015,
    "ratings": {"imdb": {"value": 7.5}},
    "genres": ["Documentary", "Music"],
    "added": "2024-11-24T15:53:18Z"
  }
]
```

## Структура полей

| **Поле**                | **Тип**             | **Описание**                                     |
| ----------------------- | ------------------- | ------------------------------------------------ |
| `title`                 | `string`            | Название фильма                                  |
| `originalTitle`         | `string`            | Оригинальное название                            |
| `originalLanguage.name` | `string`            | Язык оригинала                                   |
| `status`                | `string`            | Текущий статус (`announced`, `released`, и т.д.) |
| `overview`              | `string`            | Краткое описание                                 |
| `releaseDate`           | `string (ISO 8601)` | Дата релиза                                      |
| `tmdbId`                | `integer`           | ID фильма в TMDB                                 |
| `imdbId`                | `string`            | ID фильма в IMDb                                 |
| `path`                  | `string`            | Путь хранения на диске                           |
| `genres`                | `array[string]`     | Список жанров                                    |
| `ratings.imdb.value`    | `float`             | Средний рейтинг IMDb                             |
| `images[].remoteUrl`    | `string`            | Ссылка на постер                                 |
| `year`                  | `integer`           | Год выпуска                                      |
| `added`                 | `string (ISO 8601)` | Дата добавления в Radarr                         |


## Структура хранения данных

Импортированные фильмы сохраняются в двух связанных таблицах:

Таблица media

| **Поле**       | **Тип**                   | **Описание**              |
| -------------- | ------------------------- | ------------------------- |
| `id`           | `integer`                 | Первичный ключ            |
| `media_type`   | `enum('movie', 'series')` | Тип медиа                 |
| `title`        | `string`                  | Название                  |
| `release_date` | `datetime`                | Дата релиза               |
| `created_at`   | `datetime`                | Дата создания записи      |
| `series`       | `relationship`            | Связь с таблицей `series` |
| `movie`        | `relationship`            | Связь с таблицей `movies` |

Таблица movies

| **Поле**      | **Тип**                   | **Описание**                      |
| ------------- | ------------------------- | --------------------------------- |
| `id`          | `integer (FK → media.id)` | Ссылка на `media`                 |
| `radarr_id`   | `integer`                 | ID фильма в Radarr                |
| `tmdb_id`     | `string`                  | ID фильма в TMDB                  |
| `imdb_id`     | `string`                  | ID фильма в IMDb                  |
| `jellyfin_id` | `string`                  | ID фильма в Jellyfin              |
| `watched`     | `boolean`                 | Просмотрен ли фильм               |
| `watched_at`  | `datetime`                | Дата просмотра                    |
| `media`       | `relationship`            | Обратная связь с таблицей `media` |

Блок-схема данных Radarr → Media → Movies

```pgsql
          +------------------------------+
          |          Radarr API          |
          +------------------------------+
          |  /api/v3/movie               |
          |  X-Api-Key: <token>          |
          +------------------------------+
                      |
                      | импорт фильмов (по крону или ручке /api/v1/radarr/import)
                      v
          +------------------------------+
          |          movies              |
          +------------------------------+
          | id (PK, FK -> media.id)      |
          | radarr_id (unique)           |
          | tmdb_id (unique)             |
          | imdb_id (unique)             |
          | jellyfin_id (unique)         |
          | watched                      |
          | watched_at                   |
          +------------------------------+
                      ^
                      | 1:1 связь
                      |
          +------------------------------+
          |           media              |
          +------------------------------+
          | id (PK)                      |
          | media_type (enum: movie/series)|
          | title                         |
          | release_date                  |
          | created_at                    |
          +------------------------------+

```

## Логика импорта и обновления

Алгоритм:
1. Получаем список фильмов из Radarr.
2. Для каждого фильма выполняется проверка:
   - поиск по radarr_id
   - если не найден — поиск по tmdbId
   - если не найден — поиск по imdbId
   - если фильм не найден — создаём новую запись
   - если найден — обновляем только при изменении следующих полей:
     - status
     - releaseDate
     - tmdbId / imdbId (если были пустыми ранее)
3. Если все данные совпадают — фильм не обновляется
4. В конце импорт возвращает статистику:
   - количество новых фильмов (imported_count)
   - количество обновлённых (updated_count)

## Инициализация импорта

Импорт можно запустить двумя способами:

### HTTP API вручную
POST``http://localhost:8801/api/v1/radarr/import``

**Успешный ответ:**
```json
{
  "status": "success",
  "imported_count": 3,
  "updated_count": 2
}
```

**Ошибка:**
```json
{
  "status": "error",
  "error": {
    "code": "RADARR_FETCH_FAILED",
    "message": "Failed to connect to Radarr API"
  }
}
```

### Автоматически по расписанию (cron)
Запускается раз в сутки для актуализации данных без ручного вмешательства.

## Возможные ошибки и коды
Общие коды ошибок (ErrorCode)

| Код                | HTTP    | Описание                                 |
| ------------------ | ------- | ---------------------------------------- |
| `NETWORK_ERROR`    | 502     | Ошибка сети при обращении к внешнему API |
| `TIMEOUT_ERROR`    | 504     | Истек таймаут запроса                    |
| `DATABASE_ERROR`   | 500/409 | Ошибка работы с базой данных             |
| `VALIDATION_ERROR` | 422     | Некорректные входные данные              |
| `INTERNAL_ERROR`   | 500     | Необработанная ошибка сервера            |
| `RATE_LIMIT_ERROR` | 429     | Превышен лимит запросов                  |

Radarr-специфичные ошибки (RadarrErrorCode)

| Код                         | HTTP    | Описание                         |
| --------------------------- | ------- | -------------------------------- |
| `RADARR_FETCH_FAILED`       | 424     | Ошибка при запросе к Radarr      |
| `RADARR_EXTERNAL_API_ERROR` | 503     | Ошибка внешнего API              |
| `RADARR_NETWORK_ERROR`      | 502     | Недоступен Radarr                |
| `RADARR_DATABASE_ERROR`     | 409/500 | Конфликт или сбой БД             |
| `RADARR_INTERNAL_ERROR`     | 500     | Внутренняя ошибка сервиса        |
| `RADARR_TIMEOUT_ERROR`      | 504     | Таймаут при обращении к Radarr   |
| `RADARR_RATE_LIMIT_ERROR`   | 429     | Превышен лимит запросов к Radarr |


## Пример обработки ошибок

```json
{
  "status": "error",
  "error": {
    "code": "RADARR_NETWORK_ERROR",
    "message": "Failed to connect to external service"
  }
}
```

Ошибка базы данных
```json
{
  "status": "error",
  "error": {
    "code": "RADARR_DATABASE_ERROR",
    "message": "Database conflict: duplicate or invalid data"
  }
}
```
